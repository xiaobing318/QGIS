这份 YAML 文件定义了一个 GitHub Actions 工作流，专门用于在 Windows 平台上利用 MinGW64 工具链构建 QGIS 的 64 位版本。下面分步骤详细说明其整体作用：

 - 在 windows 平台上利用MinGW64工具链构建QGIS的64位版本。
 - 在 linux 平台下进行的操作
---

### 1. 触发条件与并发控制

- **触发时机**
  - 当代码推送到 `master`、`release-**`、`queued_ltr_backports` 分支，并且涉及到指定路径（例如 `src/**`、`external/**`、`python/**`、`tests/**`、`ms-windows/**`、`CMakeLists.txt` 等）时，会自动触发该工作流。
  - 同时也会在 Pull Request 创建或更新时触发，以及通过手动触发（workflow_dispatch）的情况。

- **并发控制**
  - 利用 `concurrency` 保证同一分支或 PR 下只运行最新的一次构建任务，并取消正在运行的旧任务，避免重复构建和资源浪费。

---

### 2. 构建环境与依赖安装

- **容器化构建**
  - 虽然运行环境基于 `ubuntu-latest`，但实际的构建在一个基于 Fedora 39 的容器中进行，并且通过挂载 GitHub 工作空间到容器中的 `/w`，确保代码和缓存能够在主机与容器之间共享。

- **系统更新与依赖安装**
  - 为了修复 `/etc/dnf/dnf.conf` 的问题，工作流首先替换了这个配置文件，并进行系统更新。
  - 接着，通过 `dnf` 安装了基础工具（如 zip）和构建依赖（通过执行 `./ms-windows/mingw/mingwdeps.sh` 脚本）以确保 MinGW64 编译环境所需的软件包到位。

- **Node.js 环境**
  - 安装 Node.js（版本 17）并启用 corepack（以确保 yarn 可用），这主要用于构建 QGIS 内部的服务器 landing page 或 web 组件。

---

### 3. 构建与缓存管理

- **缓存设置**
  - 在构建前会在工作区创建一个 ccache 目录，并通过 `actions/cache` 恢复先前的构建缓存，利用缓存机制可以加速后续的编译过程。
  - 构建结束后，如果触发事件是 push，还会保存当前的 ccache 缓存，便于未来构建使用。

- **构建命令**
  - 使用环境变量 `CCACHE_DIR` 指定缓存目录后，运行位于 `./ms-windows/mingw/build.sh` 的构建脚本，参数中指定平台架构（x86_64）、构建类型（nodebug）和并行任务数（4）。

---

### 4. 打包与上传产物

- **创建 Portable Zip 包**
  - 构建完成后，工作流将构建产物中的目标目录（位于 `build_mingw64/dist/usr/x86_64-w64-mingw32/sys-root/mingw`）整理成一个便携式版本。
  - 同时，将调试符号文件（`.debug` 文件）分离到一个单独的目录并打包为 `qgis-portable-win64-debugsym.zip`，便于开发人员调试和错误排查。

- **嵌入 PR 信息**
  - 在打包好的 Zip 文件中，会追加当前 Pull Request 编号以及构建时使用的 Git 提交哈希，便于后续追踪问题。

- **上传构建产物**
  - 使用 `actions/upload-artifact` 上传两个构建产物：一个是正式的 Windows 64 位 QGIS 可移植版本，另一个是对应的调试符号包。

---

### 5. PR 评论通知

- **下载链接评论**
  - 当事件来源于 Pull Request 时，工作流最后一步会调用自定义的 action（位于 `.github/actions/post_sticky_comment`），在 PR 中发布一条评论。
  - 评论中提供了构建产物的下载链接和调试符号的下载链接，并附带构建所用的提交哈希，方便评审人员或测试人员直接下载并验证构建成果。

---

### 总体总结

这份工作流实现了以下功能：

1. **自动触发构建**：在特定分支或 PR 提交代码时自动触发 Windows 64 位版本的构建任务。
2. **构建环境准备**：通过容器化构建、系统更新、依赖安装以及 Node.js 环境配置，确保构建环境稳定。
3. **缓存机制优化**：利用 ccache 缓存加速编译，并在构建后保存缓存，降低后续构建时间。
4. **构建与打包**：编译 QGIS 应用后将构建产物和调试符号打包为便携式 Zip 文件，并嵌入相关版本信息。
5. **产物上传与通知**：上传构建产物，并在 PR 中自动发布评论，告知相关人员下载链接和构建详情。

通过这一系列自动化流程，开发者能够高效地在 Windows 平台上构建、打包并分发 QGIS 的 64 位版本，同时快速反馈给 PR 参与者，提升整体项目的构建和测试效率。
